<div class="p-8">
  <div class="max-w-4xl mx-auto">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800 tracking-tight">
        Editar Reserva #{{ reservaId() }}
      </h2>
      <button [routerLink]="['/admin/reserva/list']"
        class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all">
        ← Volver
      </button>
    </div>

    <!-- Loading -->
    @if (loading()) {
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-12">
      <div class="flex justify-center items-center gap-2 text-gray-500">
        <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span class="text-lg">Cargando datos de la reserva...</span>
      </div>
    </div>
    }

    <!-- Formulario -->
    @else {
    <form (ngSubmit)="onSubmit()" [formGroup]="reservaForm" class="space-y-6">

      <!-- Sección: Datos del Cliente -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Datos del Cliente
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- DNI -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">DNI</label>
            <input type="text" formControlName="clienteDni" maxlength="8"
              class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              [class.border-red-500]="clienteDniInvalid" [class.border-gray-300]="!clienteDniInvalid">
            @if (clienteDniInvalid) {
            <p class="mt-1 text-sm text-red-500">DNI inválido (8 dígitos)</p>
            }
          </div>

          <!-- Correo -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
            <input type="email" formControlName="clienteCorreo"
              class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              [class.border-red-500]="clienteCorreoInvalid" [class.border-gray-300]="!clienteCorreoInvalid">
            @if (clienteCorreoInvalid) {
            <p class="mt-1 text-sm text-red-500">Correo inválido</p>
            }
          </div>

          <!-- Nombre -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
            <input type="text" formControlName="clienteNombre"
              class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              [class.border-red-500]="clienteNombreInvalid" [class.border-gray-300]="!clienteNombreInvalid">
            @if (clienteNombreInvalid) {
            <p class="mt-1 text-sm text-red-500">Nombre requerido</p>
            }
          </div>

          <!-- Apellido -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
            <input type="text" formControlName="clienteApellido"
              class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              [class.border-red-500]="clienteApellidoInvalid" [class.border-gray-300]="!clienteApellidoInvalid">
            @if (clienteApellidoInvalid) {
            <p class="mt-1 text-sm text-red-500">Apellido requerido</p>
            }
          </div>
        </div>
      </div>

      <!-- Sección: Datos de la Reserva -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Datos de la Reserva
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Fecha Inicio -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Entrada</label>
            <input type="date" formControlName="fechaInicio"
              class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              [class.border-red-500]="fechaInicioInvalid" [class.border-gray-300]="!fechaInicioInvalid">
          </div>

          <!-- Fecha Fin -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Salida</label>
            <input type="date" formControlName="fechaFin"
              class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              [class.border-red-500]="fechaFinInvalid" [class.border-gray-300]="!fechaFinInvalid">
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
            <select formControlName="estado"
              class="w-full px-4 py-2 border border-gray-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
              @for (estado of estados; track estado.value) {
              <option [value]="estado.value">{{ estado.label }}</option>
              }
            </select>
          </div>
        </div>

        <!-- Hotel -->
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Hotel</label>
          <select formControlName="hotelId" (change)="onHotelSelectChange($event)"
            class="w-full px-4 py-2 border border-gray-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="">Seleccione un hotel</option>
            @for (hotel of hoteles(); track hotel.id) {
            <option [value]="hotel.id">{{ hotel.nombre }} - {{ hotel.departamento.nombre }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Sección: Habitaciones -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          Habitaciones
          <span class="text-sm font-normal text-gray-500">
            ({{ habitacionesSeleccionadas().length }} seleccionada(s))
          </span>
        </h3>

        @if (habitacionesDisponibles().length > 0) {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          @for (habitacion of habitacionesDisponibles(); track habitacion.id) {
          <div (click)="toggleHabitacion(habitacion.id!)" class="p-4 border-2 rounded-xl cursor-pointer transition-all"
            [class.border-blue-500]="isHabitacionSeleccionada(habitacion.id!)"
            [class.bg-blue-50]="isHabitacionSeleccionada(habitacion.id!)"
            [class.border-gray-200]="!isHabitacionSeleccionada(habitacion.id!)"
            [class.hover:border-blue-300]="!isHabitacionSeleccionada(habitacion.id!)">
            <div class="flex justify-between items-start">
              <div>
                <p class="font-semibold text-gray-800">
                  Habitación {{ habitacion.numero }}
                </p>
                <p class="text-sm text-gray-600">
                  {{ habitacion.tipoHabitacion.nombre }}
                </p>
                <p class="text-xs text-gray-500">
                  Capacidad: {{ habitacion.tipoHabitacion.capacidad }} persona(s)
                </p>
              </div>
              <div class="text-right">
                <p class="font-bold text-blue-600">
                  {{ formatCurrency(habitacion.precio) }}
                </p>
                <p class="text-xs text-gray-500">por noche</p>
              </div>
            </div>

            <!-- Indicador de selección -->
            @if (isHabitacionSeleccionada(habitacion.id!)) {
            <div class="mt-2 flex items-center gap-1 text-blue-600 text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              Seleccionada
            </div>
            }

            <!-- Estado de la habitación -->
            <div class="mt-2">
              <span class="px-2 py-1 text-xs font-medium rounded-full"
                [class.bg-green-100]="habitacion.estado === 'DISPONIBLE'"
                [class.text-green-800]="habitacion.estado === 'DISPONIBLE'"
                [class.bg-red-100]="habitacion.estado === 'OCUPADA'"
                [class.text-red-800]="habitacion.estado === 'OCUPADA'"
                [class.bg-yellow-100]="habitacion.estado === 'MANTENIMIENTO'"
                [class.text-yellow-800]="habitacion.estado === 'MANTENIMIENTO'">
                {{ habitacion.estado }}
              </span>
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="text-center py-8 text-gray-500">
          <p>Seleccione un hotel para ver las habitaciones disponibles</p>
        </div>
        }
      </div>

      <!-- Resumen y Total -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl shadow-sm p-6 text-white">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-blue-100">Total de la Reserva</p>
            <p class="text-3xl font-bold">{{ formatCurrency(calcularTotal()) }}</p>
          </div>
          <div class="text-right text-blue-100 text-sm">
            <p>{{ habitacionesSeleccionadas().length }} habitación(es)</p>
            @if (reservaForm.get('fechaInicio')?.value && reservaForm.get('fechaFin')?.value) {
            <p>
              {{ reservaForm.get('fechaInicio')?.value }} al {{ reservaForm.get('fechaFin')?.value }}
            </p>
            }
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex gap-4">
        <button type="submit" [disabled]="saving()"
          class="flex-1 py-3 bg-amber-500 text-white font-medium text-sm rounded-xl hover:bg-amber-600 transition active:scale-[.98] shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
          @if (saving()) {
          <span class="flex items-center justify-center gap-2">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            Guardando...
          </span>
          } @else {
          Guardar Cambios
          }
        </button>
        <button type="button" [routerLink]="['/admin/reserva/list']"
          class="flex-1 py-3 bg-gray-100 text-gray-700 font-medium text-sm rounded-xl hover:bg-gray-200 transition">
          Cancelar
        </button>
      </div>

    </form>
    }

  </div>
</div>